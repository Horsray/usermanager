{% extends "layout.html" %}
{% block title %}台账管理{% endblock %}

{% block content %}
<!-- 页面标题 -->
<div class="d-flex justify-content-between align-items-center mb-4">
  <div class="d-flex align-items-center">
    <i class="fas fa-chart-line me-3" style="color: var(--primary-color);"></i>台账管理
  </div>
  <div class="d-flex gap-2">
    <button class="btn btn-outline-primary btn-sm" onclick="exportData()">
      <i class="fas fa-download me-2"></i>导出数据
    </button>
  </div>
</div>

<!-- 统计卡片 -->
<div class="row mb-4">
  <div class="col-md-3">
    <div class="card border-0 shadow-sm">
      <div class="card-body text-center">
        <div class="text-primary mb-2">
          <i class="fas fa-calendar-day fs-2"></i>
        </div>
        <h5 class="card-title text-muted mb-1">今日收入</h5>
        <h3 class="text-primary mb-0">¥{{ daily }}</h3>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card border-0 shadow-sm">
      <div class="card-body text-center">
        <div class="text-success mb-2">
          <i class="fas fa-calendar-alt fs-2"></i>
        </div>
        <h5 class="card-title text-muted mb-1">本月收入</h5>
        <h3 class="text-success mb-0">¥{{ monthly }}</h3>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card border-0 shadow-sm">
      <div class="card-body text-center">
        <div class="text-warning mb-2">
          <i class="fas fa-calendar fs-2"></i>
        </div>
        <h5 class="card-title text-muted mb-1">本年收入</h5>
        <h3 class="text-warning mb-0">¥{{ yearly }}</h3>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card border-0 shadow-sm">
      <div class="card-body text-center">
        <div class="text-info mb-2">
          <i class="fas fa-chart-bar fs-2"></i>
        </div>
        <h5 class="card-title text-muted mb-1">总收入</h5>
        <h3 class="text-info mb-0">¥{{ total }}</h3>
      </div>
    </div>
  </div>
</div>

<!-- 筛选表单 -->
<div class="card mb-4 border-0 shadow-sm">
  <div class="card-header bg-light">
    <h6 class="mb-0">
      <i class="fas fa-filter me-2"></i>筛选条件
    </h6>
  </div>
  <div class="card-body">
    <form method="GET" class="row g-3">
      <div class="col-md-3">
        <label class="form-label">产品</label>
        <select name="product" class="form-select">
          <option value="">全部产品</option>
          {% for p in products %}
          <option value="{{ p.name }}" {% if product_filter == p.name %}selected{% endif %}>{{ p.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">销售人员</label>
        <input type="text" name="admin" class="form-control" placeholder="输入销售人员" value="{{ admin_filter }}">
      </div>
      <div class="col-md-2">
        <label class="form-label">开始日期</label>
        <input type="date" name="start" class="form-control" value="{{ start }}">
      </div>
      <div class="col-md-2">
        <label class="form-label">结束日期</label>
        <input type="date" name="end" class="form-control" value="{{ end }}">
      </div>
      <div class="col-md-2 d-flex align-items-end">
        <div class="d-flex gap-2 w-100">
          <button class="btn btn-primary flex-fill" type="submit">
            <i class="fas fa-search me-2"></i>筛选
          </button>
          <a href="{{ url_for('ledger_view') }}" class="btn btn-outline-secondary">
            <i class="fas fa-undo"></i>
          </a>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- 台账记录表格 -->
<div class="card border-0 shadow-sm">
  <div class="card-header bg-white d-flex justify-content-between align-items-center">
    <div class="d-flex align-items-center">
      <i class="fas fa-list me-2 text-primary"></i>
      <span class="fw-bold">销售记录</span>
    </div>
    <div class="d-flex align-items-center gap-3">
      <small class="text-muted">
        显示第 {{ pagination.start_record }}-{{ pagination.end_record }} 条，共 {{ pagination.total }} 条记录
      </small>
      <div class="d-flex align-items-center gap-2">
        <label class="form-label mb-0 text-muted small">每页显示：</label>
        <select class="form-select form-select-sm" style="width: 80px;" onchange="changePerPage(this.value)">
          <option value="10" {% if pagination.per_page == 10 %}selected{% endif %}>10</option>
          <option value="20" {% if pagination.per_page == 20 %}selected{% endif %}>20</option>
          <option value="50" {% if pagination.per_page == 50 %}selected{% endif %}>50</option>
          <option value="100" {% if pagination.per_page == 100 %}selected{% endif %}>100</option>
        </select>
      </div>
    </div>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th class="border-0 fw-bold text-muted">时间</th>
            <th class="border-0 fw-bold text-muted">销售人员</th>
            <th class="border-0 fw-bold text-muted">产品</th>
            <th class="border-0 fw-bold text-muted">单价</th>
            <th class="border-0 fw-bold text-muted">数量</th>
            <th class="border-0 fw-bold text-muted">销售额</th>
          </tr>
        </thead>
        <tbody>
        {% for r in records %}
        <tr class="border-bottom">
          <td class="py-3">
            <div>
              <div class="fw-bold text-dark">{{ r.time.split(' ')[0] }}</div>
              <small class="text-muted">{{ r.time.split(' ')[1] if ' ' in r.time else '' }}</small>
            </div>
          </td>
          <td class="py-3">
             <span class="badge bg-light text-dark border">
               <i class="fas fa-user me-1"></i>{{ r.agent if r.agent else r.admin }}
             </span>
             {% if r.agent %}
             <small class="text-muted d-block mt-1">
               <i class="fas fa-arrow-right me-1"></i>审批：{{ r.admin }}
             </small>
             {% endif %}
           </td>
          <td class="py-3">
            <span class="badge bg-primary">{{ r.product }}</span>
          </td>
          <td class="py-3">
            <span class="text-success fw-bold">¥{{ "%.2f"|format(r.price) }}</span>
          </td>
          <td class="py-3">
            <span class="badge bg-info text-white">{{ r.count }}</span>
          </td>
          <td class="py-3">
            <span class="text-primary fw-bold fs-6">¥{{ "%.2f"|format(r.revenue) }}</span>
          </td>
        </tr>
        {% endfor %}
        {% if not records %}
        <tr>
          <td colspan="6" class="text-center text-muted py-5">
            <div class="d-flex flex-column align-items-center">
              <i class="fas fa-inbox fs-1 mb-3 text-muted opacity-50"></i>
              <h6 class="text-muted">暂无销售记录</h6>
              <small class="text-muted">请调整筛选条件或添加新的销售记录</small>
            </div>
          </td>
        </tr>
        {% endif %}
        </tbody>
      </table>
    </div>
  </div>
  
  <!-- 分页导航 -->
  {% if pagination.total_pages > 1 %}
  <div class="card-footer bg-light border-0">
    <nav aria-label="台账记录分页">
      <ul class="pagination justify-content-center mb-0">
        <!-- 上一页 -->
        <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
          <a class="page-link border-0" href="{% if pagination.has_prev %}{{ url_for('ledger_view', page=pagination.prev_page, per_page=pagination.per_page, product=product_filter, admin=admin_filter, start=start, end=end) }}{% else %}#{% endif %}" aria-label="上一页">
            <span aria-hidden="true">&laquo;</span>
          </a>
        </li>
        
        <!-- 页码 -->
        {% set start_page = [1, pagination.page - 2]|max %}
        {% set end_page = [pagination.total_pages, pagination.page + 2]|min %}
        
        {% if start_page > 1 %}
          <li class="page-item">
            <a class="page-link border-0" href="{{ url_for('ledger_view', page=1, per_page=pagination.per_page, product=product_filter, admin=admin_filter, start=start, end=end) }}">1</a>
          </li>
          {% if start_page > 2 %}
            <li class="page-item disabled">
              <span class="page-link border-0">...</span>
            </li>
          {% endif %}
        {% endif %}
        
        {% for page_num in range(start_page, end_page + 1) %}
          <li class="page-item {% if page_num == pagination.page %}active{% endif %}">
            <a class="page-link border-0 {% if page_num == pagination.page %}bg-primary{% endif %}" href="{{ url_for('ledger_view', page=page_num, per_page=pagination.per_page, product=product_filter, admin=admin_filter, start=start, end=end) }}">{{ page_num }}</a>
          </li>
        {% endfor %}
        
        {% if end_page < pagination.total_pages %}
          {% if end_page < pagination.total_pages - 1 %}
            <li class="page-item disabled">
              <span class="page-link border-0">...</span>
            </li>
          {% endif %}
          <li class="page-item">
            <a class="page-link border-0" href="{{ url_for('ledger_view', page=pagination.total_pages, per_page=pagination.per_page, product=product_filter, admin=admin_filter, start=start, end=end) }}">{{ pagination.total_pages }}</a>
          </li>
        {% endif %}
        
        <!-- 下一页 -->
        <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
          <a class="page-link border-0" href="{% if pagination.has_next %}{{ url_for('ledger_view', page=pagination.next_page, per_page=pagination.per_page, product=product_filter, admin=admin_filter, start=start, end=end) }}{% else %}#{% endif %}" aria-label="下一页">
            <span aria-hidden="true">&raquo;</span>
          </a>
        </li>
      </ul>
    </nav>
  </div>
  {% endif %}
</div>

<script>
function changePerPage(perPage) {
  const url = new URL(window.location);
  url.searchParams.set('per_page', perPage);
  url.searchParams.set('page', '1'); // 重置到第一页
  window.location.href = url.toString();
}

function exportData() {
  // 导出功能可以在这里实现
  alert('导出功能开发中...');
}
</script>

{% endblock %}