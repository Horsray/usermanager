{% extends 'layout.html' %}
{% block title %}数据统计{% endblock %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h2 class="mb-1" style="color: var(--gray-800); font-weight: 700;">
      <i class="fas fa-chart-bar me-3" style="color: var(--primary-color);"></i>
      {{ agent_view and '我的数据统计' or '数据统计' }}
    </h2>
    <p class="text-muted mb-0">最近30天、最近12个月的售出/收入/新增趋势与地域分布</p>
  </div>
</div>

<!-- KPI 卡片 -->
<div class="row g-3 mb-4">
  <div class="col-md-4">
    <div class="card h-100"><div class="card-body">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <div class="text-muted">今日售出</div>
          <div class="fs-3 fw-bold">{{ kpis.today_sold }}</div>
        </div>
        <div class="text-end">
          <div class="small {{ 'text-success' if kpis.dod_sold>=0 else 'text-danger' }}">
            日环比 {{ '↑' if kpis.dod_sold>=0 else '↓' }} {{ '%.1f'|format(kpis.dod_sold) }}%
          </div>
          <div class="small {{ 'text-success' if kpis.mom_sold>=0 else 'text-danger' }}">
            月环比 {{ '↑' if kpis.mom_sold>=0 else '↓' }} {{ '%.1f'|format(kpis.mom_sold) }}%
          </div>
        </div>
      </div>
      <div class="small text-muted mt-2">本月累计：{{ kpis.month_sold }}</div>
    </div></div>
  </div>
  <div class="col-md-4">
    <div class="card h-100"><div class="card-body">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <div class="text-muted">今日收入(¥)</div>
          <div class="fs-3 fw-bold">{{ '%.2f'|format(kpis.today_rev) }}</div>
        </div>
        <div class="text-end">
          <div class="small {{ 'text-success' if kpis.dod_rev>=0 else 'text-danger' }}">
            日环比 {{ '↑' if kpis.dod_rev>=0 else '↓' }} {{ '%.1f'|format(kpis.dod_rev) }}%
          </div>
          <div class="small {{ 'text-success' if kpis.mom_rev>=0 else 'text-danger' }}">
            月环比 {{ '↑' if kpis.mom_rev>=0 else '↓' }} {{ '%.1f'|format(kpis.mom_rev) }}%
          </div>
        </div>
      </div>
      <div class="small text-muted mt-2">本月累计：¥{{ '%.2f'|format(kpis.month_rev) }}</div>
    </div></div>
  </div>
  <div class="col-md-4">
    <div class="card h-100"><div class="card-body">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <div class="text-muted">今日新增用户</div>
          <div class="fs-3 fw-bold">{{ kpis.today_new }}</div>
        </div>
        <div class="text-end">
          <div class="small {{ 'text-success' if kpis.dod_new>=0 else 'text-danger' }}">
            日环比 {{ '↑' if kpis.dod_new>=0 else '↓' }} {{ '%.1f'|format(kpis.dod_new) }}%
          </div>
          <div class="small {{ 'text-success' if kpis.mom_new>=0 else 'text-danger' }}">
            月环比 {{ '↑' if kpis.mom_new>=0 else '↓' }} {{ '%.1f'|format(kpis.mom_new) }}%
          </div>
        </div>
      </div>
      <div class="small text-muted mt-2">本月累计：{{ kpis.month_new }}</div>
    </div></div>
  </div>
</div>

<!-- 图表 -->
<div class="row g-3">
  <div class="col-12">
    <div class="card"><div class="card-body">
      <div id="chart_daily_combined" style="height:340px;"></div>
    </div></div>
  </div>
  <div class="col-lg-7">
    <div class="card"><div class="card-body">
      <div id="chart_month_mix" style="height:360px;"></div>
    </div></div>
  </div>
</div>

<!-- 地理分布图表移到底部 -->
<div class="row g-3 mt-3">
  <div class="col-lg-6">
    <div class="card"><div class="card-body">
      <div id="chart_geo" style="height:360px;"></div>
    </div></div>
  </div>
  {% if province_pie %}
  <div class="col-lg-6">
    <div class="card"><div class="card-body">
      <div id="chart_province" style="height:360px;"></div>
    </div></div>
  </div>
  {% endif %}
</div>

<!-- ECharts -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
<script>
const dayLabels = {{ day_labels|tojson }};
const daySold   = {{ day_sold|tojson }};
const dayRev    = {{ day_rev|tojson }};
const dayNew    = {{ day_new|tojson }};
const monLabels = {{ month_labels|tojson }};
const monSold   = {{ mon_sold|tojson }};
const monRev    = {{ mon_rev|tojson }};
const monNew    = {{ mon_new|tojson }};
const geoPie    = {{ geo_pie|tojson }};
const provincePie = {{ province_pie|tojson }};

function movingAvg(arr, window=7) {
  const result = [];
  for (let i = 0; i < arr.length; i++) {
    const start = Math.max(0, i - window + 1);
    const slice = arr.slice(start, i + 1);
    const avg = slice.reduce((a, b) => a + b, 0) / slice.length;
    result.push(avg);
  }
  return result;
}

// 图1：日销量和收入合并
(function(){
  const chart = echarts.init(document.getElementById('chart_daily_combined'));
  
  // 格式化日期标签，只显示月日
  const formattedDayLabels = dayLabels.map(label => {
    if (label.includes('-')) {
      const parts = label.split('-');
      if (parts.length >= 3) {
        return parts[1] + '-' + parts[2]; // MM-DD格式
      }
    }
    return label;
  });
  
  chart.setOption({
    title: { text: '日销量和收入', left: 'center' },
    tooltip: { 
      trigger: 'axis',
      formatter: function(params) {
        let result = params[0].name + '<br/>';
        params.forEach(function(item) {
          if (item.seriesName === '销售量') {
            result += item.marker + item.seriesName + ': ' + item.value + '个<br/>';
          } else if (item.seriesName === '收入') {
            result += item.marker + item.seriesName + ': ¥' + item.value.toFixed(2) + '<br/>';
          } else if (item.seriesName === '7日均线(销售量)') {
            result += item.marker + item.seriesName + ': ' + item.value.toFixed(1) + '个<br/>';
          } else if (item.seriesName === '7日均线(收入)') {
            result += item.marker + item.seriesName + ': ¥' + item.value.toFixed(2) + '<br/>';
          }
        });
        return result;
      }
    },
    legend: { data: ['销售量', '收入', '7日均线(销售量)', '7日均线(收入)'], bottom: 0 },
    xAxis: { 
      type: 'category', 
      data: formattedDayLabels,
      axisLabel: {
        rotate: 45,
        interval: 0,
        fontSize: 10
      }
    },
    yAxis: [
      { type: 'value', name: '销售量(个)', position: 'left' },
      { type: 'value', name: '收入(¥)', position: 'right' }
    ],
    series: [
      { 
        name: '销售量', 
        type: 'bar', 
        data: daySold, 
        yAxisIndex: 0, 
        itemStyle: { color: '#5470c6' },
        label: { 
          show: true, 
          position: 'top', 
          formatter: '{c}个',
          fontSize: 9,
          offset: [0, -5]
        }
      },
      { 
        name: '收入', 
        type: 'line', 
        data: dayRev, 
        yAxisIndex: 1, 
        itemStyle: { color: '#ee6666' },
        label: { 
          show: true, 
          position: 'top', 
          formatter: '¥{c}',
          fontSize: 9,
          offset: [0, 5]
        }
      },
      { 
        name: '7日均线(销售量)', 
        type: 'line', 
        data: movingAvg(daySold, 7), 
        yAxisIndex: 0, 
        itemStyle: { color: '#91cc75' },
        lineStyle: { type: 'dashed' }
      },
      { 
        name: '7日均线(收入)', 
        type: 'line', 
        data: movingAvg(dayRev, 7), 
        yAxisIndex: 1, 
        itemStyle: { color: '#fac858' },
        lineStyle: { type: 'dashed' }
      }
    ]
  });
})();

// 图2：月度综合（销售量、收入、新增用户）
(function(){
  const chart = echarts.init(document.getElementById('chart_month_mix'));
  chart.setOption({
    title: { text: '月度统计', left: 'center' },
    tooltip: { 
      trigger: 'axis',
      formatter: function(params) {
        let result = params[0].name + '<br/>';
        params.forEach(function(item) {
          if (item.seriesName === '销售量') {
            result += item.marker + item.seriesName + ': ' + item.value + '个<br/>';
          } else if (item.seriesName === '收入') {
            result += item.marker + item.seriesName + ': ¥' + item.value.toFixed(2) + '<br/>';
          } else if (item.seriesName === '新增用户') {
            result += item.marker + item.seriesName + ': ' + item.value + '人<br/>';
          }
        });
        return result;
      }
    },
    legend: { data: ['销售量', '收入', '新增用户'], bottom: 0 },
    xAxis: { type: 'category', data: monLabels },
    yAxis: [
      { type: 'value', name: '数量', position: 'left' },
      { type: 'value', name: '收入(¥)', position: 'right' }
    ],
    series: [
      { 
        name: '销售量', 
        type: 'bar', 
        data: monSold, 
        yAxisIndex: 0, 
        itemStyle: { color: '#5470c6' },
        label: { show: true, position: 'top', formatter: '{c}个' }
      },
      { 
        name: '收入', 
        type: 'line', 
        data: monRev, 
        yAxisIndex: 1, 
        itemStyle: { color: '#ee6666' },
        label: { show: true, position: 'top', formatter: '¥{c}' }
      },
      { 
        name: '新增用户', 
        type: 'bar', 
        data: monNew, 
        yAxisIndex: 0, 
        itemStyle: { color: '#91cc75' },
        label: { show: true, position: 'top', formatter: '{c}人' }
      }
    ]
  });
})();

// 图5：国家分布
(function(){
  const chart = echarts.init(document.getElementById('chart_geo'));
  chart.setOption({
    title: { text: '国家分布', left: 'center' },
    tooltip: { trigger:'item', formatter: '{b}: {c} ({d}%)' },
    legend: { orient:'vertical', left:'left' },
    series: [{
      type:'pie',
      radius:'70%',
      center:['55%','50%'],
      data: geoPie,
      label: { show:true, formatter: '{b}\n{c} ({d}%)' }
    }]
  });
})();

// 图6：中国省份分布（仅当有中国数据时渲染）
(function(){
  if (!provincePie || !provincePie.length) return;
  const chart = echarts.init(document.getElementById('chart_province'));
  chart.setOption({
    title: { text: '中国省份分布', left: 'center' },
    tooltip: { trigger:'item', formatter: '{b}: {c} ({d}%)' },
    legend: { orient:'vertical', left:'left' },
    series: [{
      type:'pie',
      radius:'70%',
      center:['55%','50%'],
      data: provincePie,
      label: { show:true, formatter: '{b}\n{c} ({d}%)' }
    }]
  });
})();
</script>
{% endblock %}